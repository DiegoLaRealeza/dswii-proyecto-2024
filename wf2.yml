name: Multi-repo checkout + Maven tests (matrix)

on:
  workflow_dispatch:
    inputs:
      java-version:
        description: 'VersiÃ³n de Java'
        required: false
        default: '17'
        type: choice
        options: ['11', '17', '21']
      fail-fast:
        description: 'Detener al primer fallo'
        required: false
        default: false
        type: boolean
  push:
    branches: [main]
  schedule:
    # Ejecutar diariamente a las 6:00 AM UTC
    - cron: '0 6 * * *'

permissions:
  contents: read
  actions: read

# Evitar ejecuciones concurrentes del mismo workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REPOS_FILE: repositorios.yml

jobs:
  fetch_repos:
    name: ðŸ“¦ Fetch repos and build matrix
    runs-on: ubuntu-latest
    outputs:
      repos_json: ${{ steps.build-matrix.outputs.repos_json }}
      repo_count: ${{ steps.build-matrix.outputs.repo_count }}

    steps:
      - name: Checkout orchestrator repo
        uses: actions/checkout@v4

      # Usar acciÃ³n oficial en lugar de instalaciÃ³n manual
      - name: Setup yq
        uses: mikefarah/yq@v4

      - name: Validate config file exists
        run: |
          if [[ ! -f "$REPOS_FILE" ]]; then
            echo "::error file=$REPOS_FILE::No existe el archivo de configuraciÃ³n"
            exit 1
          fi

      - name: Build dynamic matrix
        id: build-matrix
        run: |
          REPOS_JSON="$(yq -o=json -I=0 \
            '.repositorios
             | map({
                 repo: .repo,
                 ref: (.ref // "main"),
                 dir: (.dir // (.repo | gsub("/"; "__"))),
                 mvn: (.mvn // "mvn -B test"),
                 java: (.java // "17")
               })' "$REPOS_FILE")"

          # Validar que hay repos
          REPO_COUNT=$(echo "$REPOS_JSON" | jq 'length')
          if [[ "$REPO_COUNT" -eq 0 ]]; then
            echo "::error::No se encontraron repositorios en $REPOS_FILE"
            exit 1
          fi

          echo "repos_json=$REPOS_JSON" >> "$GITHUB_OUTPUT"
          echo "repo_count=$REPO_COUNT" >> "$GITHUB_OUTPUT"

          echo "### ðŸ“‹ Repositorios encontrados: $REPO_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "$REPOS_JSON" | jq -r '.[] | "- \(.repo) (\(.ref))"' >> $GITHUB_STEP_SUMMARY

      - name: Clone all repositories
        env:
          REPO_TOKEN: ${{ secrets.REPO_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p workspace

          yq -r '.repositorios[] | [.repo, (.ref // "main"), (.dir // (.repo | gsub("/"; "__")))] | @tsv' "$REPOS_FILE" \
          | while IFS=$'\t' read -r repo ref dir; do
              echo "::group::Clonando $repo"
              git clone --no-tags --depth 1 --branch "$ref" \
                "https://x-access-token:${REPO_TOKEN}@github.com/${repo}.git" \
                "workspace/$dir"
              echo "::endgroup::"
            done

      - name: Upload workspace artifact
        uses: actions/upload-artifact@v4
        with:
          name: repos-workspace
          path: workspace
          if-no-files-found: error
          retention-days: 1
          compression-level: 6

  mvn_test:
    name: ðŸ§ª Test ${{ matrix.item.repo }}
    runs-on: ubuntu-latest
    needs: fetch_repos
    timeout-minutes: 30

    strategy:
      fail-fast: ${{ inputs.fail-fast || false }}
      max-parallel: 4
      matrix:
        item: ${{ fromJson(needs.fetch_repos.outputs.repos_json) }}

    steps:
      - name: Download workspace
        uses: actions/download-artifact@v4
        with:
          name: repos-workspace
          path: workspace

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java-version || matrix.item.java || '17' }}
          cache: maven
          cache-dependency-path: workspace/${{ matrix.item.dir }}/pom.xml

      - name: Run Maven tests
        id: maven-test
        working-directory: workspace/${{ matrix.item.dir }}
        run: |
          echo "::group::Maven Test Output"
          ${{ matrix.item.mvn }}
          echo "::endgroup::"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.item.dir }}
          path: |
            workspace/${{ matrix.item.dir }}/target/surefire-reports/
            workspace/${{ matrix.item.dir }}/target/failsafe-reports/
          if-no-files-found: ignore
          retention-days: 7

  summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [fetch_repos, mvn_test]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: all-results
          merge-multiple: true

      - name: Generate summary
        run: |
          echo "## ðŸ§ª Resumen de Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Repositorio | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Analizar resultados
          for dir in all-results/*/; do
            repo_name=$(basename "$dir")
            if find "$dir" -name "*.xml" -exec grep -l "failures=\"[1-9]" {} \; 2>/dev/null | grep -q .; then
              echo "| $repo_name | âŒ Fallido |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $repo_name | âœ… Exitoso |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check overall status
        if: needs.mvn_test.result == 'failure'
        run: |
          echo "::error::Algunos tests fallaron"
          exit 1
